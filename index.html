<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Excel Grid 106x50</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background: #f9f9f9; }
    table { border-collapse: collapse; }
    th, td {
      border: 1px solid #ccc;
      min-width: 60px;
      height: 24px;
      text-align: center;
    }
    th { background: #eee; position: sticky; top: 0; z-index: 2; }
    th:first-child, td:first-child { position: sticky; left: 0; background: #f3f3f3; z-index: 1; }
    td[contenteditable="true"]:focus { outline: 2px solid #0078D7; }
    #saveBtn { margin: 10px 0; padding: 8px 16px; }
  </style>
</head>
<body>

<button id="saveBtn">儲存至 GitHub</button>
<table id="grid">
  <thead><tr><th></th></tr></thead>
  <tbody></tbody>
</table>

<script>
const COLS = 50, ROWS = 106;
const table = document.getElementById('grid');
const theadRow = table.querySelector('thead tr');
for (let c = 0; c < COLS; c++) {
  let label = '';
  let n = c;
  while (n >= 0) {
    label = String.fromCharCode(n % 26 + 65) + label;
    n = Math.floor(n / 26) - 1;
  }
  const th = document.createElement('th');
  th.textContent = label;
  theadRow.appendChild(th);
}
const tbody = table.querySelector('tbody');
for (let r = 0; r < ROWS; r++) {
  const tr = document.createElement('tr');
  const rowTh = document.createElement('th');
  rowTh.textContent = r + 1;
  tr.appendChild(rowTh);
  for (let c = 0; c < COLS; c++) {
    const td = document.createElement('td');
    td.contentEditable = true;
    td.dataset.row = r;
    td.dataset.col = c;
    tr.appendChild(td);
  }
  tbody.appendChild(tr);
}

function getTableData() {
  const data = [];
  tbody.querySelectorAll('tr').forEach(tr => {
    const row = [];
    tr.querySelectorAll('td').forEach(td => {
      row.push(td.textContent.trim());
    });
    data.push(row);
  });
  return data;
}

function toCSV(data) {
  return data.map(r =>
    r.map(v => `"${v.replace(/"/g, '""')}"`).join(',')
  ).join('\n');
}

document.getElementById('saveBtn').onclick = async () => {
  const repo = '你的使用者名/你的repo名';
  const path = 'data.csv';
  const token = '你的 GitHub Token';
  const branch = 'main';
  const url = `https://api.github.com/repos/${repo}/contents/${path}`;
  const content = btoa(unescape(encodeURIComponent(toCSV(getTableData()))));
  const res = await fetch(url + `?ref=${branch}`, {
    headers: { Authorization: `Bearer ${token}` }
  });
  const json = await res.json();
  const sha = json.sha;

  await fetch(url, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: 'update data',
      content,
      sha,
      branch
    })
  });

  alert('✅ 已儲存至 GitHub');
};

window.getExcelGridData = getTableData;
</script>
</body>
</html>
