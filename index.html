async function save() {
  const token = prompt("請輸入 GitHub Token（僅當次使用）");
  if (!token) return;

  const data = [...tbody.rows].map(tr =>
    [...tr.cells].slice(1).map(td => td.textContent.trim())
  );

  // 重新產生腳本片段
  const newScriptContent = `
<script>
const gridData = ${JSON.stringify(data)};
const ROWS = 106, COLS = 50;
const tbody = document.getElementById("tbody");
for (let r = 0; r < ROWS; r++) {
  for (let c = 0; c < COLS; c++) {
    tbody.rows[r].cells[c + 1].textContent = gridData[r][c];
  }
}
<\/script>`;

  // 取得原始碼並替換舊 script 塊
  let raw = document.documentElement.outerHTML;
  raw = raw.replace(/<script>[^<]*gridData[^<]*<\/script>/s, newScriptContent);

  const encoded = btoa(unescape(encodeURIComponent(raw)));

  const url = `https://api.github.com/repos/${user}/${repo}/contents/${path}`;
  let sha = null;

  try {
    const shaRes = await fetch(`${url}?ref=${branch}`, {
      headers: { Authorization: `Bearer ${token}` }
    });
    const shaData = await shaRes.json();
    sha = shaData.sha;
  } catch (e) {
    alert("❌ 取得檔案失敗：" + e.message);
    return;
  }

  const res = await fetch(url, {
    method: 'PUT',
    headers: {
      Authorization: `Bearer ${token}`,
      'Content-Type': 'application/json'
    },
    body: JSON.stringify({
      message: '覆蓋 index.html（更新表格資料）',
      content: encoded,
      sha,
      branch
    })
  });

  if (res.ok) {
    alert('✅ 儲存成功，頁面已更新！');
  } else {
    const err = await res.text();
    alert('❌ 儲存失敗：' + err);
  }
}
